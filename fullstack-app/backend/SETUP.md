# Backend Setup Guide

## Prerequisites

1. **Java 17 or higher**
   ```bash
   java -version
   ```

2. **Maven 3.6+**
   ```bash
   mvn -version
   ```

3. **PostgreSQL 13+**
   ```bash
   psql --version
   ```

4. **Python 3.8+** with required packages
   ```bash
   python3 --version
   pip3 install yahooquery pandas pandas_ta
   ```

---

## Step-by-Step Setup

### 1. Create PostgreSQL Database

```bash
# Create database
createdb stockdsl

# Or using psql:
psql postgres
CREATE DATABASE stockdsl;
\q
```

### 2. Run Database Schema

```bash
cd ../database
psql stockdsl < schema.sql
```

This creates:
- `users` table
- `strategies` table
- `backtests` table
- `trades` table
- Sample demo user (username: `demo_user`, password: `password123`)

### 3. Configure Database Connection

Edit `src/main/resources/application.properties`:

```properties
spring.datasource.url=jdbc:postgresql://localhost:5432/stockdsl
spring.datasource.username=YOUR_POSTGRES_USERNAME
spring.datasource.password=YOUR_POSTGRES_PASSWORD
```

### 4. Copy ANTLR Grammar File

```bash
# Copy your existing grammar file
mkdir -p src/main/resources/antlr4
cp ../../StockDSL.g4 src/main/resources/antlr4/
```

### 5. Copy Your Translator Code

```bash
# Copy your existing Translator.java
cp ../../src/Translator.java src/main/java/com/stockdsl/compiler/
```

Note: You'll need to add `package com.stockdsl.compiler;` at the top of Translator.java

### 6. Build the Project

```bash
# This will:
# - Download Maven dependencies
# - Generate ANTLR lexer/parser from StockDSL.g4
# - Compile Java code
mvn clean install
```

### 7. Run the Backend

```bash
mvn spring-boot:run
```

You should see:
```
Started StockDslApplication in X.XXX seconds
Tomcat started on port 8080
```

### 8. Test the API

```bash
# Health check
curl http://localhost:8080/api/health

# Sign up a new user
curl -X POST http://localhost:8080/api/auth/signup \
  -H "Content-Type: application/json" \
  -d '{
    "username": "test_user",
    "email": "test@example.com",
    "password": "password123"
  }'
```

---

## Project Structure Explained

```
backend/
├── pom.xml                           # Maven dependencies
├── src/main/
│   ├── java/com/stockdsl/
│   │   ├── StockDslApplication.java      # Main entry point
│   │   ├── controller/                   # REST API endpoints
│   │   │   ├── AuthController.java          # /api/auth/*
│   │   │   ├── StrategyController.java      # /api/strategies/*
│   │   │   └── BacktestController.java      # /api/backtests/*
│   │   ├── service/                      # Business logic
│   │   │   ├── AuthService.java
│   │   │   ├── StrategyService.java
│   │   │   └── BacktestService.java
│   │   ├── model/                        # Database entities
│   │   │   ├── User.java
│   │   │   ├── Strategy.java
│   │   │   ├── Backtest.java
│   │   │   └── Trade.java
│   │   ├── repository/                   # Database queries
│   │   │   ├── UserRepository.java
│   │   │   ├── StrategyRepository.java
│   │   │   ├── BacktestRepository.java
│   │   │   └── TradeRepository.java
│   │   ├── compiler/                     # ANTLR integration
│   │   │   ├── Translator.java              # Your existing code!
│   │   │   └── CompilerService.java         # Wrapper
│   │   ├── security/                     # Authentication
│   │   │   ├── JwtUtil.java
│   │   │   └── SecurityConfig.java
│   │   └── config/                       # Configuration
│   │       └── CorsConfig.java
│   └── resources/
│       ├── application.properties        # Config file
│       └── antlr4/
│           └── StockDSL.g4              # Grammar file
└── target/                              # Compiled files
    └── generated-sources/antlr4/        # Generated by Maven
        ├── StockDSLLexer.java
        ├── StockDSLParser.java
        └── StockDSLBaseVisitor.java
```

---

## Common Issues & Solutions

### Issue 1: PostgreSQL Connection Error
```
Error: Connection refused to localhost:5432
```

**Solution:**
```bash
# Check if PostgreSQL is running
pg_isready

# Start PostgreSQL (macOS)
brew services start postgresql

# Start PostgreSQL (Linux)
sudo systemctl start postgresql
```

### Issue 2: ANTLR Generation Failed
```
Error: Could not find grammar file
```

**Solution:**
Ensure `StockDSL.g4` is in `src/main/resources/antlr4/` directory.

### Issue 3: Python Not Found
```
Error: Cannot run program "python3"
```

**Solution:**
Edit `application.properties` and set the correct Python path:
```properties
python.executable=/usr/local/bin/python3
```

Find your Python path:
```bash
which python3
```

### Issue 4: Port 8080 Already in Use
```
Error: Port 8080 is already in use
```

**Solution:**
Change port in `application.properties`:
```properties
server.port=8081
```

---

## Testing Individual Components

### Test ANTLR Compiler
```bash
cd src/main/resources/antlr4
java -jar antlr-4.13.2-complete.jar StockDSL.g4
javac *.java
```

### Test Database Connection
```bash
psql stockdsl
SELECT * FROM users;
\q
```

### Test Python Execution
```bash
python3 -c "import yahooquery; print('OK')"
```

---

## Development Workflow

1. **Make changes to Java code**
2. **Maven automatically recompiles** (thanks to spring-boot-devtools)
3. **Test with curl or Postman**
4. **Check logs** in terminal

---

## API Documentation

Once running, these endpoints are available:

### Authentication
- `POST /api/auth/signup` - Create account
- `POST /api/auth/login` - Login, get JWT token

### Strategies
- `GET /api/strategies` - List my strategies
- `POST /api/strategies` - Create strategy
- `GET /api/strategies/{id}` - Get strategy
- `PUT /api/strategies/{id}` - Update strategy
- `DELETE /api/strategies/{id}` - Delete strategy

### Backtests
- `POST /api/backtests/run/{strategyId}` - Run backtest
- `GET /api/backtests/strategy/{strategyId}` - Get history
- `GET /api/backtests/{id}` - Get specific backtest
- `GET /api/backtests/{id}/trades` - Get trades

---

## Next Steps

After backend is running:
1. Set up the React frontend
2. Test the full flow: signup → create strategy → run backtest
3. Deploy to cloud (AWS, Heroku, etc.)
